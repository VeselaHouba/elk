input {
#Below are defined inputs from redis for hsapp logs
    redis {
   		host      => "localhost"
   		port      => 6379
   		data_type => "list"
   		key       => "hsapp"
  	}
}

filter {
	if [type] == "hsapp" {
	    #Below is defined log filtering for hosel apps
    	if "processed" not in [tags] {
            grok {
                match => { "message" => "%{HSAPP1}"}
                patterns_dir => ["./patterns"]
                add_tag => ["processed", "HSAPP1"]
               }
        }
        if "processed" not in [tags] {
            grok {
                match => { "message" => "%{HSAPP2}"}
                patterns_dir => ["./patterns"]
                remove_tag => ["_grokparsefailure"]
                add_tag => ["processed", "HSAPP2"]
                }
        }
        if "processed" not in [tags] {
            grok {
                match => { "message" => "%{HSAPP3}"}
                patterns_dir => ["./patterns"]
                add_tag => ["processed","HSAPP3"]
            }
        }
   	mutate {
    		rename => [ "host", "Unix_Hostname" ]
    			add_tag => [ "%{type}" ]
  		}
  		date {
		# Adjusting delay between deliver row to server
			match => ["App_timestamp", "YYYY-MM-dd HH:mm:ss,SSS"]
			timezone => "Asia/Hong_Kong"
        	}
	}
	
	# this filter avoids duplicate messages. Very important, especially when rotating files
	uuid {
		target => "@uuid"
		overwrite => true
	}
	fingerprint {
		source => ["message"]
		target => "fingerprint"
		key => "78787878"
		method => "SHA1"
		concatenate_sources => true
	}
}
output {
	if ([type] == "hsapp" ) {
		elasticsearch {
			document_id => "%{fingerprint}"
			hosts => "cn-vx130.prod.tj.itc.homecredit.cn"
			template => "/opt/elk/logstash/elasticsearch-template_hci_2.json"
			template_overwrite => true
		}
	}
}
