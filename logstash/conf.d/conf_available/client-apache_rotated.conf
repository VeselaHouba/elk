input {
	file {
		type => "apache_access"
		path => [ 
			"/mnt/apache/*/*access*log-*"
		]
		exclude => [
			"*.gz",
			"*.zip"
		]
#		start_position => "beginning"
		discover_interval => 5
	}
	file {
		type => "apache_error"
		path => [ "/mnt/apache/*/*error*log-*" ]
		exclude => [
			"*.gz",
			"*.zip"
		]
#		start_position => "beginning"
		discover_interval => 5
	}
}

filter {
	if [type] == "apache_error" {
		multiline {
			pattern => "^\[%{DAY}"
			negate  => true
			what	=> "previous"
		}
	}
	# throttle rate - sleep for 10 sec every 1000 lines
	sleep {
		every	=> 1000
		time	=> 1
	}
	mutate {
		add_tag => [ "rotated" ]
        add_field => { "Country" => "CN" }
        add_field => { "Environment" => "PROD" }
	}
}
output {
	redis {
		#host => ["cn-vx130.prod.tj.itc.homecredit.cn"]
		# note that this is not LB but failover only
		host => ["acn-log01.prod.itc.homecredit.cn","cn-vx130.prod.tj.itc.homecredit.cn"]
		data_type => "list"
		port => "6379"
		key => "apache_rotated"
	}
}

